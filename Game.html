<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Game</title>

    <style type="text/css">
        .gem {
            height: 30px;
            width: 30px;
            border-radius: 10px;
            display: inline-block;
        }

        .gem.gem-red {
            background-color: red;
        }

        .gem.gem-green {
            background-color: green;
        }

        .gem.gem-blue {
            background-color: blue;
        }

        .gem.gem-destroyed {
            background-color: white;
        }

        .game-field {
            height: 302px;
            width: 302px;
            border-style: solid;
        }

        .selected {
            border-color: black;
            border-width: 2px;
            border-style: solid;
            width: 26px;
            height: 26px;
        }
    </style>

    <script src="./js/jquery-2.2.4.min.js"></script>

</head>
<body>

<div class="game-field">
    <span class="gem gem-red"></span>
    <span class="gem gem-blue"></span>
    <span class="gem gem-green"></span>

    <span class="gem gem-blue"></span>
    <span class="gem gem-red"></span>
    <span class="gem gem-green"></span>

    <span class="gem gem-green"></span>
    <span class="gem gem-red"></span>
    <span class="gem gem-blue"></span>

    <span class="gem gem-blue"></span>
    <span class="gem gem-green"></span>
    <span class="gem gem-red"></span>

    <span class="gem gem-red"></span>
    <span class="gem gem-green"></span>
    <span class="gem gem-blue"></span>

    <span class="gem gem-green"></span>
    <span class="gem gem-red"></span>
    <span class="gem gem-blue"></span>

    <span class="gem gem-green"></span>
    <span class="gem gem-blue"></span>
    <span class="gem gem-red"></span>

    <span class="gem gem-blue"></span>
    <span class="gem gem-green"></span>
    <span class="gem gem-red"></span>

    <span class="gem gem-red"></span>
    <span class="gem gem-blue"></span>
    <span class="gem gem-green"></span>

    <span class="gem gem-red"></span>
    <span class="gem gem-green"></span>
    <span class="gem gem-blue"></span>

    <span class="gem gem-red"></span>
    <span class="gem gem-green"></span>
    <span class="gem gem-blue"></span>

    <span class="gem gem-green"></span>
    <span class="gem gem-blue"></span>
    <span class="gem gem-red"></span>

    <span class="gem gem-green"></span>
    <span class="gem gem-red"></span>
    <span class="gem gem-blue"></span>

    <span class="gem gem-red"></span>
    <span class="gem gem-green"></span>
    <span class="gem gem-blue"></span>

    <span class="gem gem-red"></span>
    <span class="gem gem-blue"></span>
    <span class="gem gem-green"></span>

    <span class="gem gem-green"></span>
    <span class="gem gem-red"></span>
    <span class="gem gem-blue"></span>

    <span class="gem gem-red"></span>
    <span class="gem gem-green"></span>
    <span class="gem gem-blue"></span>

    <span class="gem gem-red"></span>
    <span class="gem gem-blue"></span>
    <span class="gem gem-green"></span>

    <span class="gem gem-red"></span>
    <span class="gem gem-blue"></span>
    <span class="gem gem-green"></span>

    <span class="gem gem-red"></span>
    <span class="gem gem-green"></span>
    <span class="gem gem-blue"></span>

    <span class="gem gem-red"></span>
    <span class="gem gem-green"></span>
    <span class="gem gem-blue"></span>

    <span class="gem gem-red"></span>
    <span class="gem gem-green"></span>
    <span class="gem gem-blue"></span>

    <span class="gem gem-red"></span>
    <span class="gem gem-green"></span>
    <span class="gem gem-blue"></span>

    <span class="gem gem-red"></span>
    <span class="gem gem-green"></span>
    <span class="gem gem-blue"></span>

    <span class="gem gem-red"></span>
    <span class="gem gem-green"></span>
    <span class="gem gem-blue"></span>

    <span class="gem gem-red"></span>
    <span class="gem gem-green"></span>
    <span class="gem gem-blue"></span>

    <span class="gem gem-red"></span>
    <span class="gem gem-green"></span>
    <span class="gem gem-blue"></span>
</div>

<script>

    const NEIGHBOUR_DISTANCE = 1;
    var selectedGem = null;

    function swapClassNames(lefElement, rightElement) {
        var thisClassName = $(lefElement).attr("class");
        $(lefElement).attr("class", $(rightElement).attr("class"));
        $(rightElement).attr("class", thisClassName);
    }

    function deselectGem(gem) {
        $(gem).removeClass("selected");
        selectedGem = null;
    }

    function isSelected(gem) {
        return selectedGem === gem;
    }

    function someGemIsSelected() {
        return selectedGem !== null;
    }

    function swapGemWithSelected(gem) {
        swapClassNames(gem, selectedGem);
        deselectGem(gem);
    }

    function selectGem(gem) {
        $(gem).addClass("selected");
        selectedGem = gem;
    }

    function getGemCoordinates(gem) {
        return {
            col: ($(gem).offset().left - 11) / 34,
            row: ($(gem).offset().top - 11) / 34
        };
    }

    function columnDistance(coordinates, otherCoordinates) {
        return Math.abs(coordinates.col - otherCoordinates.col);
    }

    function rowDistance(coordinates, otherCoordinates) {
        return Math.abs(coordinates.row - otherCoordinates.row);
    }

    function getDistance(gem, otherGem) {
        var coordinates = getGemCoordinates(gem);
        var otherCoordinates = getGemCoordinates(otherGem);
        return columnDistance(coordinates, otherCoordinates) + rowDistance(coordinates, otherCoordinates);
    }

    function areNeighbours(gem, otherGem) {
        return getDistance(gem, otherGem) === NEIGHBOUR_DISTANCE;
    }

    function putGemIntoTableByCoordinates(table, row, col, gem) {
        table[row] = table[row] || [];
        table[row][col] = gem;
    }

    function putGemIntoTable(table, gem) {
        var coordinates = getGemCoordinates(gem);

        putGemIntoTableByCoordinates(table, coordinates.row, coordinates.col, gem);
    }
    function getGemsCoordinateLookupTable() {
        var table = [];

        $(".gem").each(function () {
            putGemIntoTable(table, $(this));
        });
        return table;
    }
    $(".gem").click(function () {
        var clickedGem = this;

        if (isSelected(clickedGem)) {
            deselectGem(clickedGem);
        } else {
            if (someGemIsSelected()) {
                if (areNeighbours(clickedGem, selectedGem)) {
                    var selectedGemBeforeSwap = selectedGem;

                    swapGemWithSelected(clickedGem);

                    var lookupTable = getGemsCoordinateLookupTable();

                    var row, col, firstGem, secondGem, thirdGem, matching;

                    matching = false;

                    for (row = 0; row < lookupTable.length; row++) {
                        for (col = 0; col < lookupTable[row].length - 2; col++) {
                            firstGem = $(lookupTable[row][col]);
                            secondGem = $(lookupTable[row][col + 1]);
                            thirdGem = $(lookupTable[row][col + 2]);

                            if (firstGem.attr("class") === secondGem.attr("class") &&
                                    firstGem.attr("class") === thirdGem.attr("class") &&
                                    firstGem.attr("class") &&
                                    !firstGem.hasClass("gem-destroyed")) {
                                firstGem.addClass("gem-destroyed");
                                secondGem.addClass("gem-destroyed");
                                thirdGem.addClass("gem-destroyed");
                                matching = true;
                            }
                        }
                    }

                    for (row = 0; row < lookupTable.length - 2; row++) {
                        for (col = 0; col < lookupTable[row].length; col++) {
                            firstGem = $(lookupTable[row][col]);
                            secondGem = $(lookupTable[row + 1][col]);
                            thirdGem = $(lookupTable[row + 2][col]);

                            if (firstGem.attr("class") === secondGem.attr("class") &&
                                    firstGem.attr("class") === thirdGem.attr("class") &&
                                    firstGem.attr("class") &&
                                    !firstGem.hasClass("gem-destroyed")) {
                                firstGem.addClass("gem-destroyed");
                                secondGem.addClass("gem-destroyed");
                                thirdGem.addClass("gem-destroyed");
                                matching = true;
                            }
                        }
                    }

                    if (!matching) {
                        swapClassNames(clickedGem, selectedGemBeforeSwap);
                    }


                } else {
                    deselectGem(selectedGem);
                }

            } else {
                selectGem(clickedGem);
            }
        }
    })
</script>
</body>
</html>